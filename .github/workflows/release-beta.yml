name: Release Beta

on:
  workflow_dispatch:
  # SDK uses automatic triggers on develop branch, but for now
  # we'll manually trigger.
  # push:
  #   branches: [main]

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release-beta:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Check RELEASE_PAT secret exists
        run: |
          if [ -z "${{ secrets.RELEASE_PAT }}" ]; then
            echo "Error: RELEASE_PAT secret is required but not set"
            echo "This workflow requires a Personal Access Token to bypass branch protection rules"
            exit 1
          fi
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Use PAT to bypass branch protection rules when committing and pushing
          token: ${{ secrets.RELEASE_PAT }}
      # Branch check is necessary for manual triggers (workflow_dispatch) to ensure
      # we only push version changes to main. If using automatic push triggers,
      # the trigger itself would enforce the branch, but manual triggers can run
      # from any branch.
      - name: Check branch is main
        run: |
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "Error: This workflow must be run on the main branch"
            exit 1
          fi
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          registry-url: "https://registry.npmjs.org"
      - run: npm ci
      - run: npm run check

      - name: Enter prerelease mode (if not already)
        run: |
          if [ ! -f .changeset/pre.json ]; then
            npx changeset pre enter beta
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .changeset/pre.json
            git commit -m "chore: enter beta prerelease mode"
          fi

      - name: Version packages
        run: npm run version-packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create .npmrc
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > .npmrc
          echo "@hypercerts-org:registry=https://registry.npmjs.org/" >> .npmrc

      - name: Publish beta packages
        # Use npm run release to match regular releases - it runs check before publishing
        # to ensure validation after versioning (package.json/changelog changes)
        run: npm run release
        env:
          NPM_CONFIG_PROVENANCE: true

      - name: Commit and push version changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "chore: version packages (beta)"
          git push
